name: PR

on:
  pull_request:

permissions:
  contents: read
  id-token: write

# If POT file needs change, commit that change and stop the workflow
# If not, check that building debian package and docker image works

jobs:

  check-pot:
    runs-on: buildjet-2vcpu-ubuntu-2004
    outputs:
      skip-rest: ${{ steps.auto-commit.outputs.changes_detected }}

    steps:
    - uses: actions/checkout@v3
      with:
        ref: ${{ github.head_ref }}
        token: ${{ secrets.GH_PUSH_PAT }}

    - name: Check if last commit is an auto commit
      id: is-autogenerated
      run: |
        if [ "$(git log -1 --pretty=%B)" = "BSS-6765 Autogenerate translation template" ]; then
          echo "value=true" >> $GITHUB_OUTPUT
        else
          echo "value=false" >> $GITHUB_OUTPUT
        fi

    - name: Setup deps
      if: steps.is-autogenerated.outputs.value == 'false'
      run: |
        sudo apt-get update
        sudo apt-get install -y gettext
    - name: Generate non-trivial pot file
      if: steps.is-autogenerated.outputs.value == 'false'
      run: |
        xgettext --from-code=UTF-8 src/assets/js/serverMessages/*.js -L JavaScript -j -o src/assets/js/utils/vendor/i18n/translation-template_v1.pot

        # Discard the changes if only creation date/time has changed
        diff1=$(git diff --numstat src/assets/js/utils/vendor/i18n/translation-template_v1.pot)
        diff2=1$'\t'1$'\t'src/assets/js/utils/vendor/i18n/translation-template_v1.pot
        if [ "$diff1" = "$diff2" ]; then
          echo "Only datetime changed in po template, skipping commit"
          git checkout -- src/assets/js/utils/vendor/i18n/translation-template_v1.pot
        fi
    - id: auto-commit
      uses: stefanzweifel/git-auto-commit-action@v4
      if: steps.is-autogenerated.outputs.value == 'false'
      with:
        commit_message: "BSS-6765 Autogenerate translation template"
        file_pattern: src/assets/js/utils/vendor/i18n/translation-template_v1.pot

  build:
    runs-on: buildjet-2vcpu-ubuntu-2004
    needs: check-pot
    if: needs.check-pot.outputs.skip-rest != 'true'
    outputs:
      build-vsn: ${{ steps.get-version.outputs.build-vsn }}
    steps:
    - uses: actions/checkout@v3
    - name: Get version
      id: get-version
      run: |
        git fetch --prune --unshallow
        echo "build-vsn=$(git describe --dirty --abbrev=7 --tags --always --first-parent)" >> $GITHUB_OUTPUT
    - name: Use Node.js 8
      uses: actions/setup-node@v3
      with:
        node-version: 8
        cache: 'npm'
    - name: npm install
      run: |
        npm install
        npm prune
    - name: Build package
      run: |
        node node_modules/.bin/gulp --production
        cd dist
        ./package.sh run

  build-images:
    name: Build images
    needs: build
    uses: ./.github/workflows/build-images.yml
    with:
      extra_tag: ${{ needs.build.outputs.build-vsn }}
